<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <script>
    sessionStorage.PAGINA_DESEJADA = "./dashProcessos.html"
    if (!(sessionStorage.ID_SERVIDOR >= 1)) {
      window.location = "./selecionarServidor.html"
    }
  </script>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>NextRail | Processos</title>
  <link rel="icon" href="assets/icon/nextrail-logo.jpg">

  <script src="./js/sessao.js"></script>
  <link rel="stylesheet" href="./css/menu.css">
  <link rel="stylesheet" href="./css/dashProcessos.css">
  <script src="js/adap_dash_cargo.js"></script>
  <script src="js/dashcomponentes.js"></script>

  <link rel="preconnect" href="https://fonts.gstatic.com">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>



</head>

<body onload="carregarComponentes()">
  <div class="menu">
    <ul class="link-items">
      <div class="logo-container">
        <img src="./assets/icon/logo-SFroxo.png" alt="Logo NextRail" class="logo-menu">
      </div>
      <li class="link-item" id="dashboard">
        <a href="selecionarServidor.html" class="link">
          <ion-icon name="grid-outline"></ion-icon>
          <span style="--i: 1">Servidores</span>
        </a>
      </li>
      <li class="link-item" id="dashboard">
        <a href="dashboard.html" class="link">
          <ion-icon name="pulse-outline"></ion-icon>
          <span style="--i: 2">Uso Componentes</span>
        </a>
      </li>
      <li class="link-item active" id="dashboard">
        <a href="dashProcessos.html" class="link">
          <ion-icon name="layers-outline"></ion-icon>
          <span style="--i: 3">Processos</span>
        </a>
      </li>
      <li class="link-item" id="cadastroServer">
        <a href="cadastroServidor.html" class="link">
          <ion-icon name="construct-outline"></ion-icon>
          <span style="--i: 4">Cadastrar Servidor</span>
        </a>
      </li>
      <li class="link-item" id="configuracoes">
        <a href="configAlerta.html" class="link">
          <ion-icon name="settings-outline"></ion-icon>
          <span style="--i: 5">Parâmetros</span>
        </a>
      </li>
      <li class="link-item">
        <a onclick="limparSessao()" class="link">
          <ion-icon name="log-out-outline"></ion-icon>
          <span style="--i: 7">Sair</span>
        </a>
      </li>
    </ul>
  </div>

  <!-- Menu hamburger -->
  <div class="hamburger" id="hamburger">
    <span></span>
    <span></span>
    <span></span>
  </div>

  <main class="dashprocessos" id="dashprocessos">
    <div class="container-secao">

      <div class="texto-secao">
        <h2>Acompanhamento diário dos Processos</h2>
      </div>

      <div class="container-geral" id="containerGeral" style="max-width: 98%; margin: 0 auto;">
        <div class="container-KPIS">
          <div class="KPI">
            <h2>Pico de processos do dia:</h2>
            <h2 id="maximoProcessos"></h2>
          </div>
          <div class="KPI">
            <h2>Média de processos do dia:</h2>
            <h2 id="mediaProcessos"></h2>
          </div>
          <div class="KPI">
            <h2>Processo com maior uso de memória do dia:</h2>
            <h2 id="textoProcessoFrequente"></h2>
          </div>
        </div>
        <div class="container-KPIS-segunda-linha">
          <div class="GRAFICO-2">
            <h2 id="mensagemQtdProcesso">Quantidade dos processos das últimas 24h:</h2>
            <canvas id="varicaoUso"></canvas>
          </div>

          <div class="KPI com-grafico">
            <h2 id="UsoMemoriaProcesso">Uso de memória dos processos (Em MB):</h2>
            <canvas id="frequenciaProcessosChart"></canvas>
          </div>

        </div>

      </div>
    </div>

    </div>
  </main>



  <!-- Scripts -->
  <script type="module" src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.esm.js"></script>
  <script nomodule src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.js"></script>
  <script src="./js/script.js"></script>

</body>
<script>
  async function carregarDados() {
    const res = await fetch("http://localhost:3333/api/processos");
    const dados = await res.json();

    if (dados.erro) {
      console.error("Erro do servidor:", dados.erro);
      document.getElementById('mensagemQtdProcesso').innerText = dados.erro;
      return {labelsMemoria: [], memoriaMB: [], horarios: [], processos24h: []};
    }

    return dados;
  }

  async function montarGraficos() {
    try {
      console.log('Iniciando carregamento de dados...');

      const dados = await carregarDados();

      console.log('Dados recebidos da API:', dados);

      if (dados.maximoProcessos !== undefined) {
        document.getElementById('maximoProcessos').textContent = dados.maximoProcessos;
      }
      if (dados.mediaProcessos !== undefined) {
        document.getElementById('mediaProcessos').textContent = dados.mediaProcessos;
      }
      if (dados.processoMaisFrequente) {
        document.getElementById('textoProcessoFrequente').textContent = dados.processoMaisFrequente;
      }

      if (!dados.labelsMemoria || dados.labelsMemoria.length === 0) {
        console.warn('Sem dados para gráficos');
        document.getElementById('mensagemQtdProcesso').innerText += ' (Sem dados)';
        return;
      }

      const ctx1 = document.getElementById('frequenciaProcessosChart');
      if (ctx1) {
        new Chart(ctx1, {
          type: 'bar',
          data: {
            labels: dados.labelsMemoria,
            datasets: [{
              label: "MB de memória",
              data: dados.memoriaMB,
              backgroundColor: 'rgba(56,189,248,1)',
              borderColor: 'rgba(56,189,248,0)',
              borderWidth: 2,
              borderRadius: 8
            },


            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              title: {
                display: true,
                text: '5 maiores Processos - Uso de Memória'
              }
            }
          }
        });
      }

      const ctx2 = document.getElementById('varicaoUso');
      if (ctx2 && dados.horarios && dados.horarios.length > 0) {
        new Chart(ctx2, {
          type: 'line',
          data: {
            labels: dados.horarios,
            datasets: [{
              label: 'Quantidade de processos',
              data: dados.processos24h,
              borderColor: '#a78bfa',
              backgroundColor: 'rgba(167,139,250,0.2)',
              tension: 0.3,
              fill: true,
              pointRadius: 4,
              borderWidth: 2
            },
            {
              label: 'Media de processos',
              data: Array(dados.horarios.length).fill(dados.mediaProcessos),
              borderColor: '#f6fa2d',
              backgroundColor: '#f9fc3d',
              borderWidth: 2,
              tension: 0.4,
              fill: false,
              pointRadius: 0,
              datalabels: {display: false}
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false
          }
        });
      }

      console.log('Gráficos montados com sucesso!');

    } catch (error) {
      console.error('Erro ao montar gráficos:', error);
      document.getElementById('mensagemQtdProcesso').innerText = 'Erro ao carregar dados: ' + error.message;
    }
  }

  montarGraficos();
</script>

</html>
